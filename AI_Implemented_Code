#include <Servo.h>

Servo servo1;
Servo servo2;
Servo servo3;
Servo servog;  // create servo object to control a servo
// twelve servo objects can be created on most boards
int s1pin = 9;
int s2pin = 10;
int s3pin = 11;
int sgpin = 6;
int m1stp = 4;
int m1dir = 5;
int m2stp = 2;
int m2dir = 3;
int but1 = 24;
int but2 = 25;
int but3 = 26;
int ledr = 31;
int ledg = 30;

int pos = 0;  // variable to store the servo position
int receivedChar;
boolean newData = false;
void setup() {
  Serial.begin(9600);
  //Trapdoor
  servo1.attach(s1pin);
  servo2.attach(s2pin);
  servo3.attach(s3pin);
  servog.attach(sgpin);
  //Stepper 1
  pinMode(m1dir, OUTPUT);
  pinMode(m1stp, OUTPUT);
  digitalWrite(m1stp, LOW);
  //
  digitalWrite(m1dir, LOW);

  //Stepper 2
  pinMode(m2stp, OUTPUT);
  pinMode(m2dir, OUTPUT);
  digitalWrite(m2stp, LOW);
  //
  digitalWrite(m2dir, LOW);

  //IN PINS
  pinMode(but1, INPUT_PULLUP);
  pinMode(but2, INPUT_PULLUP);
  pinMode(but3, INPUT_PULLUP);
  digitalWrite(but1, HIGH);
  digitalWrite(but2, HIGH);
  digitalWrite(but3, HIGH);

  //LED
  pinMode(ledr, OUTPUT);
  pinMode(ledg, OUTPUT);
}

int sequence(int x) {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  // Stepper moves
  int move = (x - 1) * 1181;
 // Serial.println("Gantry Move 1");
  //Serial.println(move);
  for (int i = 0; i <= move; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  delay(500);
  // Trapdoor open
  if (x == 1) {
    //Serial.println("Opening Trapdoor 1");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo1.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
    //Serial.println("Closing Trapdoor 1");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
      servo1.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
  } else if (x == 2) {
    //Serial.println("Opening Trapdoor 2");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo2.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
    //Serial.println("Closing Trapdoor 2");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
      servo2.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
  } else if (x == 3) {
    //Serial.println("Opening Trapdoor 3");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 180 degrees to 0 degrees
      servo3.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
    //Serial.println("Closing Trapdoor 3");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo3.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
  }
  Serial.println("C");
  // get y (in ai)
  while (!Serial.available()) {
    delay(10);
  }
  int y = 0;
  char RxedByte = 0;
  //Serial.println(RxedByte);
  RxedByte = Serial.read();    
      switch(RxedByte)
      {
        case 'A':  digitalWrite(12,HIGH);
                   delay(1000);
                   digitalWrite(12,LOW);
                   y = 3;

        case 'B': digitalWrite(12,HIGH);
                  delay(3000);
                  digitalWrite(12,LOW);
                  y = 2; //your code
                  break;
        case 'C': y = 1;
                  digitalWrite(12,HIGH);
                  delay(5000);
                  digitalWrite(12,LOW);
                  break;
        default: digitalWrite(LED_BUILTIN, HIGH);
                   break;
      }//end of switch()
  if (x == y) {
    digitalWrite(ledg, HIGH);
  }
  else {
    digitalWrite(ledr, HIGH);
  }
  //Serial.println(y);
  int move2nd = y - x;
  //Serial.println(move2nd);
  int move2 = (abs(move2nd) * 1181);
  int move3 = (y - 1) * 1181;
  // Gantry moves to Correct Category bin
  if (move2nd < 0) {
    digitalWrite(5, HIGH);
    digitalWrite(3, HIGH);
  }
  //Serial.println("Gantry Move 2");
  //Serial.println(move2);
  for (int i = 0; i <= move2; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  delay(500);
  //Gantry Trapdoor
  //Serial.println("Opening Trapdoor Gantry");
  for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
    // in steps of 1 degree
    servog.write(pos);  // tell servo to go to position in variable 'pos'
    delay(30);          // waits 15ms for the servo to reach the position
  }
  delay(3000);
  //Serial.println("Closing Trapdoor Gantry");
  for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
    servog.write(pos);                  // tell servo to go to position in variable 'pos'
    delay(30);                          // waits 15ms for the servo to reach the position
  }
  digitalWrite(5, HIGH);
  digitalWrite(3, HIGH);
  //Get steppers back to original Position
  //Serial.println("Returning to Home");
  //Serial.println(move3);
  for (int i = 0; i <= move3; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  digitalWrite(5, LOW);
  digitalWrite(3, LOW);
  digitalWrite(12, HIGH);
  delay(5000);
  digitalWrite(12, LOW);
  digitalWrite(ledg, LOW);
  digitalWrite(ledr, LOW);
}


void loop() {
  if (digitalRead(but1) == LOW) {
    sequence(3);
  } else if (digitalRead(but2) == LOW) {
    sequence(2);
  } else if (digitalRead(but3) == LOW) {
    sequence(1);
  }
}
