#include <Servo.h>

Servo servo1;
Servo servo2;
Servo servo3;
Servo servog;  // create servo object to control a servo
// twelve servo objects can be created on most boards
int s1pin = 9;
int s2pin = 10;
int s3pin = 11;
int sgpin = 6;
int m1stp = 4;
int m1dir = 5;
int m2stp = 2;
int m2dir = 3;
int but1 = 24;
int but2 = 25;
int but3 = 26;
int ledr = 31;
int ledg = 30;

int pos = 0;  // variable to store the servo position
int receivedChar;
boolean newData = false;
void setup() {
  Serial.begin(9600);
  //Trapdoor
  servo1.attach(s1pin);
  servo2.attach(s2pin);
  servo3.attach(s3pin);
  servog.attach(sgpin);
  //Stepper 1
  pinMode(m1dir, OUTPUT);
  pinMode(m1stp, OUTPUT);
  digitalWrite(m1stp, LOW);
  //
  digitalWrite(m1dir, LOW);

  //Stepper 2
  pinMode(m2stp, OUTPUT);
  pinMode(m2dir, OUTPUT);
  digitalWrite(m2stp, LOW);
  //
  digitalWrite(m2dir, LOW);

  //IN PINS
  pinMode(but1, INPUT_PULLUP);
  pinMode(but2, INPUT_PULLUP);
  pinMode(but3, INPUT_PULLUP);

  //LED
  pinMode(ledr, OUTPUT);
  pinMode(ledg, OUTPUT);
}

int sequence(int x, int y) {
  delay(1000);
  // Stepper moves
  int move = (x - 1) * 1181;
  Serial.println("Gantry Move 1");
  Serial.println(move);
  for (int i = 0; i <= move; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  delay(500);
  // Trapdoor open
  if (x == 1) {
    Serial.println("Opening Trapdoor 1");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo1.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
    Serial.println("Closing Trapdoor 1");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
      servo1.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
  } else if (x == 2) {
    Serial.println("Opening Trapdoor 2");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo2.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
    Serial.println("Closing Trapdoor 2");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
      servo2.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
  } else if (x == 3) {
    Serial.println("Opening Trapdoor 3");
    for (pos = 90; pos >= 0; pos -= 1) {  // goes from 180 degrees to 0 degrees
      servo3.write(pos);                  // tell servo to go to position in variable 'pos'
      delay(30);                          // waits 15ms for the servo to reach the position
    }
    delay(1000);
    Serial.println("Closing Trapdoor 3");
    for (pos = 0; pos <= 90; pos += 1) {  // goes from 0 degrees to 180 degrees
      // in steps of 1 degree
      servo3.write(pos);  // tell servo to go to position in variable 'pos'
      delay(30);          // waits 15ms for the servo to reach the position
    }
    delay(2000);
  }
  // get y (in ai)
  int move2nd = y - x;
  int move2 = (abs(move2nd) * 1181);
  int move3 = (y - 1) * 1181;
  // Gantry moves to Correct Category bin
  if (move2nd < 0) {
    digitalWrite(5, HIGH);
    digitalWrite(3, HIGH);
  }
  Serial.println("Gantry Move 2");
  Serial.println(move2);
  for (int i = 0; i <= move2; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  delay(500);
  //Gantry Trapdoor
  Serial.println("Opening Trapdoor Gantry");
  for (pos = 90; pos >= 0; pos -= 1) {  // goes from 0 degrees to 180 degrees
    // in steps of 1 degree
    servog.write(pos);  // tell servo to go to position in variable 'pos'
    delay(30);          // waits 15ms for the servo to reach the position
  }
  delay(3000);
  Serial.println("Closing Trapdoor Gantry");
  for (pos = 0; pos <= 90; pos += 1) {  // goes from 180 degrees to 0 degrees
    servog.write(pos);                  // tell servo to go to position in variable 'pos'
    delay(30);                          // waits 15ms for the servo to reach the position
  }
  digitalWrite(5, HIGH);
  digitalWrite(3, HIGH);
  //Get steppers back to original Position
  Serial.println("Returning to Home");
  Serial.println(move3);
  for (int i = 0; i <= move3; i++) {
    digitalWrite(2, HIGH);
    digitalWrite(4, HIGH);
    delay(3);
    digitalWrite(2, LOW);
    digitalWrite(4, LOW);
    delay(3);
  }
  digitalWrite(5, LOW);
  digitalWrite(3, LOW);
}

void loop() {
  if (Serial.available() > 0) {
    receivedChar = Serial.read();
    newData = true;
  }
  if (newData == true) {
    Serial.println(receivedChar);
    if (receivedChar == 49) {
      sequence(1, 2);
    } else if (receivedChar == 50) {
      sequence(2, 1);
    } else if (receivedChar == 51) {
      sequence(3, 2);
    }
    newData = false;
  }
  delay(100);
}
